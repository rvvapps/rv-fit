<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Entrenamientos RV</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#2563eb">
<link rel="manifest" href="/rv-fit/manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="RV FIT">

<link rel="apple-touch-icon" sizes="180x180" href="/rv-fit/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="512x512" href="/rv-fit/icon-512.png">

<style>
:root{--primary:#2563eb;--scheduled:#fde68a;--done:#22c55e;--border:#cbd5e1;--bg:#f8fafc;--weekend:#e5e7eb;}
html,body{height:100%;background:var(--bg);}
body{margin:0;font-family:system-ui,-apple-system,sans-serif;padding:calc(14px + env(safe-area-inset-top)) calc(14px + env(safe-area-inset-right)) calc(14px + env(safe-area-inset-bottom)) calc(14px + env(safe-area-inset-left));-webkit-font-smoothing:antialiased;}
.container{max-width:440px;margin:auto;background:#fff;border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.14);padding:14px;}
h1{margin:4px 0 10px;text-align:center;font-size:1.1rem}
button{border:1px solid var(--border);background:#fff;border-radius:10px;padding:.42rem .6rem;font-size:.78rem}
button:disabled{opacity:.45}
button.active{background:var(--primary);border-color:var(--primary);color:#fff}
.nav{display:flex;justify-content:space-between;align-items:center;gap:8px}
#label{font-weight:800;color:var(--primary);background:rgba(37,99,235,.12);border:1px solid rgba(37,99,235,.18);padding:.25rem .6rem;border-radius:999px}
.center{display:flex;justify-content:center;margin:10px 0}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
.day-name{text-align:center;font-size:.7rem;font-weight:700;color:#334155}
.day{height:64px;border:1px solid var(--border);border-radius:12px;text-align:center;position:relative;user-select:none;touch-action:manipulation;background:#fff}
.day.weekend{background:var(--weekend)}
.day.selected{outline:2px solid var(--primary)}
.day.scheduled{background:var(--scheduled)}
.day.done{background:var(--done);color:#fff}
.day.done::after{content:"‚úî";position:absolute;top:4px;right:7px}
.num{margin-top:6px;font-weight:800}
.time{font-size:.65rem}
.empty{visibility:hidden}
.row{display:flex;gap:10px}
.card{flex:1;border:1px solid var(--border);border-radius:14px;padding:10px}
.cardhead{display:flex;justify-content:space-between;align-items:baseline;font-size:.75rem}
.bar{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;margin-top:6px}
.fill{height:100%;background:var(--primary);width:0%;transition:width .25s ease}
.actions{display:flex;gap:10px;margin:12px 0 6px}
.action{flex:1;font-weight:900}
.panel{display:none;border:1px solid var(--border);border-radius:14px;padding:10px;margin:8px 0}
.panel.show{display:block}
.preset{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
input[type=time], input[type=number]{border:1px solid var(--border);border-radius:10px;padding:.35rem .5rem;font-size:.78rem}
.quick-row{display:flex;align-items:center;gap:6px;margin:8px 0;justify-content:center;flex-wrap:wrap}
.quick-row strong{min-width:70px;text-align:right;color:#334155}
.annual{display:none;border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
.annual.show{display:block}
.annual-row{display:flex;gap:6px}
.annual-month{flex:1;font-size:.62rem;text-align:center}
.annual-bar{height:6px;background:#e5e7eb;border-radius:999px;overflow:hidden;display:flex;margin:4px 0}
.annual-done{background:var(--done)}
.annual-sched{background:var(--scheduled)}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:.5rem .9rem;border-radius:14px;font-size:.75rem;opacity:0;transition:.25s}
.toast.show{opacity:1}
.dot{width:8px;height:8px;border-radius:999px;background:#ef4444;display:none;margin-left:6px}
</style>
</head>
<body>
<div class="container">
  <h1>Entrenamientos</h1>

  <div class="nav">
    <button id="prev" type="button">‚óÄ</button>
    <div id="label"></div>
    <button id="next" type="button">‚ñ∂</button>
  </div>

  <div class="center" id="goNowWrap" style="display:none">
    <button id="goNow" type="button">üìç Mes actual</button>
  </div>

  <div class="calendar" id="cal"></div>

  <div class="row" id="progressRow" style="display:none">
    <div class="card">
      <div class="cardhead"><div style="font-weight:900">Semana actual</div><div id="weekMeta">0/0</div></div>
      <div class="bar"><div class="fill" id="weekFill"></div></div>
    </div>
    <div class="card">
      <div class="cardhead"><div style="font-weight:900">Mes actual</div><div id="monthMeta">0/0</div></div>
      <div class="bar"><div class="fill" id="monthFill"></div></div>
    </div>
  </div>

  <div class="annual" id="annual"></div>
  <div class="center"><button id="annualBtn" type="button">üìä Mostrar resumen anual</button></div>

  <div class="actions">
    <button class="action" id="btnProgram" type="button">‚öôÔ∏è Programaci√≥n</button>
    <button class="action" id="btnBackup" type="button">üíæ Respaldo <span class="dot" id="backupDot"></span></button>
  </div>

  <div class="panel" id="programPanel">
    <div class="preset" id="presetRow">
      <button type="button" data-time="06:30">06:30</button>
      <button type="button" data-time="07:00">07:00</button>
      <button type="button" data-time="07:30">07:30</button>
      <button type="button" data-time="--:--">--:--</button>
    </div>
    <div class="center" style="gap:8px;align-items:center">
      <input type="time" id="manualTime">
      <button id="manualOk" type="button">OK</button>
    </div>

    <div class="center"><button id="toggleQuick" type="button">‚ö° Programaci√≥n r√°pida</button></div>
    <div class="panel" id="quickPanel" style="margin:0">
      <div class="quick-row" id="quickDays">
        <strong>D√≠a</strong>
        <button type="button" data-qday="1">L</button><button type="button" data-qday="2">M</button><button type="button" data-qday="3">W</button>
        <button type="button" data-qday="4">J</button><button type="button" data-qday="5">V</button><button type="button" data-qday="6">S</button>
        <button type="button" data-qday="0">D</button>
      </div>
      <div class="quick-row" id="quickTimes">
        <strong>Hora</strong>
        <button type="button" data-qtime="06:30">06:30</button><button type="button" data-qtime="07:00">07:00</button>
        <button type="button" data-qtime="07:30">07:30</button><button type="button" data-qtime="--:--">--:--</button>
        <input type="time" id="quickManual" style="margin-left:6px">
        <button id="quickManualOk" type="button">OK</button>
      </div>
      <div class="center"><button id="applyQuick" type="button">Programar</button></div>
    </div>

    <div class="center" id="cleanRow" style="display:none;gap:10px">
      <button id="cw" type="button">üßπ Semana</button>
      <button id="cm" type="button">üóë Mes</button>
      <button id="ca" type="button">üî• Todo</button>
      <button id="doClean" type="button">Borrar</button>
    </div>
  </div>

  <div class="panel" id="backupPanel">
    <div id="backupStatus" style="text-align:center;font-weight:900;color:#334155;margin-bottom:8px">‚Äî</div>
    <div class="row">
      <button id="export" type="button">Exportar</button>
      <button id="importBtn" type="button">Importar</button>
    </div>
    <input type="file" id="file" accept="application/json" style="display:none">
  </div>

  <div class="panel" id="historyPanel">
    <div class="row" style="align-items:center">
      <div style="flex:1;text-align:center"><div style="font-weight:900;color:#334155">Programados</div><input id="hPlan" type="number"></div>
      <div style="flex:1;text-align:center"><div style="font-weight:900;color:#334155">Reales</div><input id="hDone" type="number"></div>
      <button id="saveHist" type="button" style="height:44px">Guardar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ====== Data + migration ======
const STORAGE="rv-data", HST="rv-history", META="rv-backup-meta";
const dayNames=["L","M","M","J","V","S","D"];
const monthNames=["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
const monthsShort=["E","F","M","A","M","J","J","A","S","O","N","D"];

const $=s=>document.querySelector(s);
const cal=$("#cal"), label=$("#label"), toast=$("#toast");
const progressRow=$("#progressRow"), weekMeta=$("#weekMeta"), weekFill=$("#weekFill"), monthMeta=$("#monthMeta"), monthFill=$("#monthFill");
const annual=$("#annual"), annualBtn=$("#annualBtn");
const programPanel=$("#programPanel"), backupPanel=$("#backupPanel"), historyPanel=$("#historyPanel");
const btnProgram=$("#btnProgram"), btnBackup=$("#btnBackup"), backupDot=$("#backupDot"), backupStatus=$("#backupStatus");
const goNowWrap=$("#goNowWrap");
const cleanRow=$("#cleanRow");

let current=new Date();
let selected=null;
let activePanel=null;
let quickDays=new Set();
let quickTime=null;
let cleanMode=null;

function pad2(n){return String(n).padStart(2,"0");}
function dateKey(dt){return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;}
function ymKey(y,m0){return `${y}-${pad2(m0+1)}`;}
function keyToDate(k){const [y,m,d]=k.split("-").map(Number); const dt=new Date(y,m-1,d); dt.setHours(0,0,0,0); return dt;}
function isISODate(k){return /^\d{4}-\d{2}-\d{2}$/.test(k);}
function isISOYM(k){return /^\d{4}-\d{2}$/.test(k);}
function safeParse(s,f){try{return JSON.parse(s);}catch(_){return f;}}

let data=safeParse(localStorage.getItem(STORAGE)||"{}",{});
let history=safeParse(localStorage.getItem(HST)||"{}",{});

function saveAll(){localStorage.setItem(STORAGE,JSON.stringify(data));localStorage.setItem(HST,JSON.stringify(history));}

function migrate(){
  let changed=false;
  const nd={};
  for(const k of Object.keys(data)){
    const v=data[k];
    if(isISODate(k)){nd[k]=v; continue;}
    const p=String(k).split("-");
    if(p.length===3){
      const yy=+p[0], mm0=+p[1], dd=+p[2];
      if(!Number.isNaN(yy)&&!Number.isNaN(mm0)&&!Number.isNaN(dd)){
        nd[`${yy}-${pad2(mm0+1)}-${pad2(dd)}`]=v; changed=true; continue;
      }
    }
    nd[k]=v;
  }
  data=nd;
  const nh={};
  for(const k of Object.keys(history)){
    const v=history[k];
    if(isISOYM(k)){nh[k]=v; continue;}
    const p=String(k).split("-");
    if(p.length===2){
      const yy=+p[0], mm0=+p[1];
      if(!Number.isNaN(yy)&&!Number.isNaN(mm0)){
        nh[`${yy}-${pad2(mm0+1)}`]=v; changed=true; continue;
      }
    }
    nh[k]=v;
  }
  history=nh;
  if(changed) saveAll();
}

// ====== Stats index (A) ======
const stats=Object.create(null);
function ensure(ym){ if(!stats[ym]) stats[ym]={plan:0,done:0}; return stats[ym]; }
function rebuild(){
  for(const k of Object.keys(stats)) delete stats[k];
  for(const k of Object.keys(data)){
    if(!isISODate(k)) continue;
    const ym=k.slice(0,7);
    const s=ensure(ym);
    s.plan++;
    if(data[k]?.done) s.done++;
  }
}
function applyDelta(key, prev, next){
  if(!isISODate(key)) return;
  const ym=key.slice(0,7);
  const s=ensure(ym);
  const pe=!!prev, ne=!!next;
  if(!pe && ne) s.plan++;
  if(pe && !ne) s.plan=Math.max(0,s.plan-1);
  const pd=pe?!!prev.done:false;
  const nd=ne?!!next.done:false;
  if(!pd && nd) s.done++;
  if(pd && !nd) s.done=Math.max(0,s.done-1);
}

// ====== UI helpers ======
function toastMsg(t){toast.textContent=t;toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),1400);}
function isPastMonth(){
  const n=new Date();
  return current.getFullYear()<n.getFullYear() || (current.getFullYear()===n.getFullYear() && current.getMonth()<n.getMonth());
}
function isCurrentMonth(){
  const n=new Date();
  return current.getFullYear()===n.getFullYear() && current.getMonth()===n.getMonth();
}
function startOfWeekMon(dt){
  const d=new Date(dt); d.setHours(0,0,0,0);
  const shift=(d.getDay()+6)%7;
  d.setDate(d.getDate()-shift);
  return d;
}

function setTimeForSelected(t){
  if(isPastMonth()) return;
  if(!selected) return toastMsg("Selecciona un d√≠a");
  const prev=data[selected]?{...data[selected]}:null;
  const next={time:t, done:false};
  data[selected]=next;
  applyDelta(selected, prev, next);
  saveAll();
  render();
}
function toggleDone(key){
  if(isPastMonth()) return false;
  if(!data[key]) return false;
  const dt=keyToDate(key);
  const today=new Date(); today.setHours(0,0,0,0);
  if(dt>today) return false;
  const prev={...data[key]};
  data[key].done=!data[key].done;
  const next={...data[key]};
  applyDelta(key, prev, next);
  saveAll();
  return true;
}
function delDay(key){
  if(isPastMonth()) return false;
  if(!data[key]) return false;
  const prev={...data[key]};
  delete data[key];
  applyDelta(key, prev, null);
  saveAll();
  return true;
}

// ====== Render (B) ======
function render(){
  const y=current.getFullYear(), m0=current.getMonth();
  label.textContent = `${monthNames[m0]} ${y}`;

  const past=isPastMonth(), cur=isCurrentMonth();
  progressRow.style.display = (!past && cur) ? "flex" : "none";
  goNowWrap.style.display = cur ? "none" : "flex";
  historyPanel.classList.toggle("show", past);
  btnProgram.disabled = past;
  cleanRow.style.display = (!past && cur) ? "flex" : "none";

  // history inputs
  if(past){
    const ym=ymKey(y,m0);
    const h=history[ym]||{plan:"",done:""};
    $("#hPlan").value = h.plan ?? "";
    $("#hDone").value = h.done ?? "";
  }

  // calendar
  cal.innerHTML="";
  const frag=document.createDocumentFragment();
  for(const dn of dayNames){
    const el=document.createElement("div");
    el.className="day-name"; el.textContent=dn;
    frag.appendChild(el);
  }
  const first=(new Date(y,m0,1).getDay()||7);
  const total=new Date(y,m0+1,0).getDate();
  for(let i=1;i<first;i++){ const e=document.createElement("div"); e.className="empty"; frag.appendChild(e); }
  for(let d=1; d<=total; d++){
    const dt=new Date(y,m0,d); dt.setHours(0,0,0,0);
    const k=dateKey(dt);
    const cell=document.createElement("div");
    cell.className="day"; cell.dataset.key=k;
    const dow=dt.getDay(); if(dow===0||dow===6) cell.classList.add("weekend");
    if(k===selected) cell.classList.add("selected");
    const rec=data[k];
    if(rec) cell.classList.add(rec.done?"done":"scheduled");
    const num=document.createElement("div"); num.className="num"; num.textContent=d;
    const tm=document.createElement("div"); tm.className="time"; tm.textContent=rec?.time||"";
    cell.append(num, tm);
    frag.appendChild(cell);
  }
  cal.appendChild(frag);

  if(!past && cur){
    renderWeekBar();
    renderMonthBar();
  }
  renderAnnualIfOpen();
  updateBackupUI();
}

function renderWeekBar(){
  const today=new Date(); today.setHours(0,0,0,0);
  const ws=startOfWeekMon(today);
  let plan=0, done=0;
  for(let i=0;i<7;i++){
    const dt=new Date(ws); dt.setDate(ws.getDate()+i);
    const k=dateKey(dt);
    if(data[k]){ plan++; if(data[k].done) done++; }
  }
  weekMeta.textContent=`${done}/${plan}`;
  weekFill.style.width = plan ? Math.round(done/plan*100)+"%" : "0%";
}
function renderMonthBar(){
  const ym=ymKey(current.getFullYear(), current.getMonth());
  const s=stats[ym]||{plan:0,done:0};
  monthMeta.textContent=`${s.done}/${s.plan}`;
  monthFill.style.width = s.plan ? Math.round(s.done/s.plan*100)+"%" : "0%";
}
function renderAnnualIfOpen(){
  if(!annual.classList.contains("show")) return;
  annual.innerHTML="";
  const y=current.getFullYear();
  const row=document.createElement("div"); row.className="annual-row";
  for(let m0=0;m0<12;m0++){
    const ym=ymKey(y,m0);
    let plan=0, done=0;
    if(history[ym]){ plan=+history[ym].plan||0; done=+history[ym].done||0; }
    else { const s=stats[ym]||{plan:0,done:0}; plan=s.plan; done=s.done; }
    const pct=plan?done/plan:0;
    const c=document.createElement("div"); c.className="annual-month";
    c.innerHTML = `<strong>${monthsShort[m0]}</strong>
      <div class="annual-bar"><div class="annual-done" style="width:${(pct*100).toFixed(1)}%"></div><div class="annual-sched" style="width:${((1-pct)*100).toFixed(1)}%"></div></div>
      ${done}/${plan}`;
    row.appendChild(c);
  }
  annual.appendChild(row);
}

// ====== Panels ======
function closePanels(){
  activePanel=null;
  programPanel.classList.remove("show");
  backupPanel.classList.remove("show");
  btnProgram.classList.remove("active");
  btnBackup.classList.remove("active");
}
function togglePanel(which){
  if(which==="program" && isPastMonth()) return;
  if(activePanel===which){ closePanels(); return; }
  closePanels();
  activePanel=which;
  if(which==="program"){ programPanel.classList.add("show"); btnProgram.classList.add("active"); }
  else { backupPanel.classList.add("show"); btnBackup.classList.add("active"); updateBackupUI(); }
}

// ====== Backup ======
function getMeta(){return safeParse(localStorage.getItem(META)||"{}",{});}
function setMeta(m){localStorage.setItem(META, JSON.stringify(m||{}));}
function daysSince(iso){
  if(!iso) return null;
  const t=new Date(iso); if(isNaN(t)) return null;
  return Math.floor((Date.now()-t.getTime())/(1000*60*60*24));
}
function updateBackupUI(){
  const meta=getMeta();
  const d=daysSince(meta.lastBackup);
  let show=false;
  if(d===null) { backupStatus.textContent="‚ö†Ô∏è A√∫n no has hecho ning√∫n respaldo"; show=true; }
  else if(d>=60){ backupStatus.textContent=`üî¥ √öltimo respaldo hace ${d} d√≠as`; show=true; }
  else if(d>=30){ backupStatus.textContent=`‚ö†Ô∏è No has hecho respaldo en ${d} d√≠as`; show=true; }
  else backupStatus.textContent=`√öltimo respaldo: hace ${d} d√≠a${d===1?"":"s"}`;
  backupDot.style.display = show ? "inline-block" : "none";
}
function exportBackup(){
  const payload={version:"3.0",exportedAt:new Date().toISOString(),data,history};
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="rv-fit-backup.json"; document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url),1000);
  setMeta({lastBackup:new Date().toISOString()});
  updateBackupUI();
  toastMsg("Respaldo exportado");
}
async function importBackup(file){
  const text=await file.text();
  const obj=JSON.parse(text);
  if(!obj?.data || !obj?.history) return toastMsg("Archivo inv√°lido");
  if(!confirm("¬øReemplazar datos actuales con este respaldo?")) return;
  data=obj.data; history=obj.history;
  migrate(); rebuild(); saveAll();
  toastMsg("Respaldo restaurado");
  closePanels();
  render();
}

// ====== Quick ======
function normTime(v){return (v||"").trim().slice(0,5);}
function applyQuick(){
  if(isPastMonth()) return;
  if(!quickTime) return toastMsg("Elige una hora");
  if(!quickDays.size) return toastMsg("Elige d√≠as");
  const y=current.getFullYear(), m0=current.getMonth();
  const total=new Date(y,m0+1,0).getDate();
  for(let d=1; d<=total; d++){
    const dt=new Date(y,m0,d); dt.setHours(0,0,0,0);
    if(quickDays.has(dt.getDay())){
      const k=dateKey(dt);
      if(!data[k]){
        const next={time:quickTime, done:false};
        data[k]=next;
        applyDelta(k, null, next);
      }
    }
  }
  saveAll(); toastMsg("Programaci√≥n aplicada"); render();
}

// ====== Clean ======
function setClean(m){cleanMode=m; ["cw","cm","ca"].forEach(id=>$("#"+id).classList.remove("active")); $("#"+(m==="week"?"cw":m==="month"?"cm":"ca")).classList.add("active");}
function doClean(){
  if(isPastMonth()) return;
  if(!cleanMode) return toastMsg("Selecciona qu√© borrar");
  if(cleanMode==="all"){
    if(!confirm("¬øBorrar todo el calendario?")) return;
    data={}; rebuild(); saveAll(); selected=null; toastMsg("Todo borrado"); render(); return;
  }
  if(!selected) return toastMsg("Selecciona un d√≠a");
  const base=keyToDate(selected);
  if(cleanMode==="week"){
    const ws=startOfWeekMon(base);
    for(let i=0;i<7;i++){
      const dt=new Date(ws); dt.setDate(ws.getDate()+i);
      const k=dateKey(dt);
      if(data[k]){ const prev={...data[k]}; delete data[k]; applyDelta(k, prev, null); }
    }
    saveAll(); selected=null; toastMsg("Semana borrada"); render(); return;
  }
  if(cleanMode==="month"){
    const y=base.getFullYear(), m0=base.getMonth();
    const total=new Date(y,m0+1,0).getDate();
    for(let d=1; d<=total; d++){
      const dt=new Date(y,m0,d); dt.setHours(0,0,0,0);
      const k=dateKey(dt);
      if(data[k]){ const prev={...data[k]}; delete data[k]; applyDelta(k, prev, null); }
    }
    saveAll(); selected=null; toastMsg("Mes borrado"); render(); return;
  }
}

// ====== History ======
function saveHist(){
  const ym=ymKey(current.getFullYear(), current.getMonth());
  history[ym]={plan:+$("#hPlan").value||0, done:+$("#hDone").value||0};
  localStorage.setItem(HST, JSON.stringify(history));
  toastMsg("Hist√≥rico guardado");
  renderAnnualIfOpen();
}

// ====== Delegated calendar events + long press ======
let pressTimer=null, longTriggered=false, lastTouch=0;
const LONG_MS=650;

function hit(ev){
  const cell=ev.target.closest?.(".day");
  if(!cell || !cal.contains(cell)) return null;
  return {cell, key:cell.dataset.key};
}
function onTap(key){
  selected=key;
  toggleDone(key);
  render();
}
function startPress(ev){
  const h=hit(ev); if(!h) return;
  if(isPastMonth()) return;
  longTriggered=false;
  clearTimeout(pressTimer);
  pressTimer=setTimeout(()=>{
    longTriggered=true;
    if(delDay(h.key)){ toastMsg("D√≠a eliminado"); if(selected===h.key) selected=null; render(); }
    else toastMsg("Nada que borrar");
  }, LONG_MS);
}
function endPress(ev){
  clearTimeout(pressTimer);
  if(longTriggered) return;
  const h=hit(ev);
  if(ev.type==="touchend" || ev.type==="touchcancel"){
    lastTouch=Date.now();
    if(h) onTap(h.key);
  }
}

cal.addEventListener("click",(ev)=>{
  if(Date.now()-lastTouch<450) return;
  const h=hit(ev); if(h) onTap(h.key);
});
cal.addEventListener("touchstart", startPress, {passive:true});
cal.addEventListener("touchend", endPress, {passive:true});
cal.addEventListener("touchcancel", endPress, {passive:true});
cal.addEventListener("mousedown", startPress);
cal.addEventListener("mouseup", ()=>{clearTimeout(pressTimer); longTriggered=false;});
cal.addEventListener("mouseleave", ()=>{clearTimeout(pressTimer); longTriggered=false;});

// ====== Wire UI ======
$("#prev").addEventListener("click",()=>{current.setMonth(current.getMonth()-1); selected=null; closePanels(); render();});
$("#next").addEventListener("click",()=>{current.setMonth(current.getMonth()+1); selected=null; closePanels(); render();});
$("#goNow").addEventListener("click",()=>{current=new Date(); selected=null; closePanels(); render();});
btnProgram.addEventListener("click",()=>togglePanel("program"));
btnBackup.addEventListener("click",()=>togglePanel("backup"));

annualBtn.addEventListener("click",()=>{
  const open=annual.classList.toggle("show");
  annualBtn.textContent=open?"üìä Ocultar resumen anual":"üìä Mostrar resumen anual";
  if(open) renderAnnualIfOpen();
});

$("#presetRow").addEventListener("click",(ev)=>{
  const b=ev.target.closest("button[data-time]"); if(!b) return;
  setTimeForSelected(b.dataset.time);
});
$("#manualOk").addEventListener("click",()=>{
  const t=normTime($("#manualTime").value);
  if(!t) return toastMsg("Ingresa una hora");
  setTimeForSelected(t);
});

$("#toggleQuick").addEventListener("click",()=>$("#quickPanel").classList.toggle("show"));
$("#quickDays").addEventListener("click",(ev)=>{
  const b=ev.target.closest("button[data-qday]"); if(!b) return;
  const d=+b.dataset.qday;
  if(quickDays.has(d)){quickDays.delete(d); b.classList.remove("active");}
  else {quickDays.add(d); b.classList.add("active");}
});
$("#quickTimes").addEventListener("click",(ev)=>{
  const b=ev.target.closest("button[data-qtime]");
  if(!b) return;
  quickTime=b.dataset.qtime;
  document.querySelectorAll("#quickTimes button[data-qtime]").forEach(x=>x.classList.remove("active"));
  b.classList.add("active");
});
$("#quickManualOk").addEventListener("click",()=>{
  const t=normTime($("#quickManual").value);
  if(!t) return toastMsg("Ingresa una hora");
  quickTime=t;
  document.querySelectorAll("#quickTimes button[data-qtime]").forEach(x=>x.classList.remove("active"));
  toastMsg("Hora r√°pida aplicada");
});
$("#applyQuick").addEventListener("click",applyQuick);

$("#cw").addEventListener("click",()=>setClean("week"));
$("#cm").addEventListener("click",()=>setClean("month"));
$("#ca").addEventListener("click",()=>setClean("all"));
$("#doClean").addEventListener("click",doClean);

$("#saveHist").addEventListener("click",saveHist);

$("#export").addEventListener("click",exportBackup);
$("#importBtn").addEventListener("click",()=>$("#file").click());
$("#file").addEventListener("change", async (ev)=>{
  const f=ev.target.files?.[0]; if(!f) return;
  try{ await importBackup(f);}catch(e){console.error(e); toastMsg("Error al importar");}
});

// ====== Init ======
migrate();
rebuild();
render();
</script>

<script>
// ====== SW register (scope fijo /rv-fit/) ======
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('/rv-fit/sw.js', { scope: '/rv-fit/' });
      await reg.update();

      if (reg.waiting && navigator.serviceWorker.controller) showUpdateToast(reg.waiting);

      reg.addEventListener('updatefound', () => {
        const w = reg.installing;
        if (!w) return;
        w.addEventListener('statechange', () => {
          if (w.state === 'installed' && navigator.serviceWorker.controller) showUpdateToast(w);
        });
      });

      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (window.__reloading) return;
        window.__reloading = true;
        window.location.reload();
      });
    } catch (e) { console.error("SW error", e); }
  });
}

function showUpdateToast(worker) {
  if (document.getElementById('updateToast')) return;
  const t = document.createElement("div");
  t.id = "updateToast";
  t.style.cssText="position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(15,23,42,.95);color:#fff;padding:12px 14px;border-radius:16px;font-size:13px;display:flex;gap:12px;align-items:center;z-index:999999";
  t.innerHTML = `Nueva versi√≥n disponible <button id="btnUpdate" style="background:#2563eb;color:#fff;border:none;padding:7px 10px;border-radius:12px;font-size:13px;font-weight:800">Actualizar</button>`;
  document.body.appendChild(t);
  document.getElementById("btnUpdate").addEventListener("click", ()=>worker.postMessage("SKIP_WAITING"));
}
</script>
</body>
</html>
